---
title: ORM Injection
desc: What is ORM Injection?
date: 2024-11-16
thumbnail: /posts/advanced_skill/orm_injection/thumbnail.png
---

## What's ORM Injection?
ORM Injectionì€ ORM(Object Relational Mapping)ë„êµ¬ì— Injection í•˜ëŠ” ê³µê²©ì´ë‹¤.
í•´ë‹¹ ì·¨ì•½ì ì€ SQL Injectionê³¼ ê°™ì´ ì•…ì˜ì ì¸ SQLë¬¸ì„ ì‚¬ìš©í•˜ì—¬ DBì— ì ‘ê·¼í•  ìˆ˜ ìžˆê²Œ ëœë‹¤.

ORM ë„êµ¬ ê°œë°œ ì½”ë“œì— ì·¨ì•½ì ì´ ì¡´ìž¬í•  ë•Œ ORM Injectionì´ ê°€ëŠ¥í•´ì§„ë‹¤.
ë”°ë¼ì„œ ê³µê²© ëŒ€ìƒì´ êµ¬ë²„ì „ì˜ ORMì„ ì‚¬ìš©ì¤‘ì´ë¼ë©´ ORM Injection ì·¨ì•½ì  ì¡´ìž¬ ê°€ëŠ¥ì„±ì´ ë†’ì„ ìˆ˜ ìžˆë‹¤. 

---
## Background

### SQL Injection
SQL Injectonì€ ì•…ì˜ì ì¸ SQLêµ¬ë¬¸ì„ ê³µê²© ì„œë¹„ìŠ¤ì— ì „ë‹¬í•˜ì—¬ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì •ìƒì ì¸ SQLêµ¬ë¬¸ì˜ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì—¬ ê³µê²©ìžê°€ ì„œë¹„ìŠ¤ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìžˆëŠ” ì·¨ì•½ì  ìž…ë‹ˆë‹¤.

### ORM
ORMì€ Object Relational Mappingì˜ ì•½ìžë¡œ ì†ŒìŠ¤ì½”ë“œì˜ ì˜¤ë¸Œì íŠ¸ì™€ ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë¥¼ ë§µí•‘í•˜ì—¬ SQLë¬¸ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì†ŒìŠ¤ì½”ë“œë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìžˆëŠ” ë„êµ¬ìž…ë‹ˆë‹¤.

ì•„ëž˜ëŠ” ëŒ€í‘œì ì¸ ì–¸ì–´ë³„ ORM ë¦¬ìŠ¤íŠ¸ìž…ë‹ˆë‹¤.
|Language|ORM|
|------|---|
|Java|JPA, Hibernate|
|Python|QuerySet(Django), SQLAlchemy(Flask)|
|Node.js|Sequalize, Prisma|

---
## Detection
ORM Injection ì·¨ì•½ì ì´ ì¡´ìž¬í•˜ëŠ”ì§€ ì•Œê¸° ìœ„í•´ì„œëŠ” ìš°ì„  í•´ë‹¹ ì„œë¹„ìŠ¤ì—ì„œ ì–´ë–¤í•œ ORMì„ ì‚¬ìš©í•˜ëŠ”ì§€ íŒŒì•…í•˜ëŠ”ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤.
ORMì˜ ì •ë³´ë¥¼ í™•ì¸í–ˆë‹¤ë©´ í•´ë‹¹ ORMì˜ CVEë¥¼ ì°¾ì•„ ORM Injection ê³µê²© ê°€ëŠ¥ì„± ì—¬ë¶€ë¥¼ íŒë‹¨í•´ì•¼ ë©ë‹ˆë‹¤.

---
## Attack
### CVE-2024-42005(Django QuerySet)
ë¹„êµì  ìµœê·¼ì— ë‚˜ì˜¨ CVEë¡œ Djangoì˜ ORMì¸ QuerySetì—ì„œ ORM Injection ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

ì·¨ì•½ì ì€ **Django 5.0 ~ 5.0.8, 4.2 ~ 4.2.15** ë²„ì „ì˜ `QuerySet.values()`ì™€ `values_list()`ì— ì¡´ìž¬í•œë‹¤ê³  í•©ë‹ˆë‹¤.

>ðŸš«PoCëŠ” ì•…ìš©ë  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì— ì˜¬ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**Vulnerable Code**
ëª¨ë¸ì˜ ë°ì´í„° ì†ì„±ì„ JSONFieldìœ¼ë¡œ ì„ ì–¸í•˜ì˜€ì„ ë•Œ ì·¨ì•½
```python
# models.py
from django.db import models
 
class MyModel(models.Model):
    #ë°ì´í„° ì†ì„±ì„ Jsonìœ¼ë¡œ ì„ ì–¸
    data = models.JSONField()
 
    def __str__(self):
        return str(self.data)
```
### HQL Injection
HQLì€ Hibernate Query Languageì˜ ì¤„ìž„ë§ìž…ë‹ˆë‹¤.
ì·¨ì•½ì ì€ ë§ ê·¸ëŒ€ë¡œ Hibernateì—ì„œ HQLì„ í†µí•´ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ìž…ë‹ˆë‹¤.

ì•„ëž˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë³„ HQL Injection Payloadìž…ë‹ˆë‹¤.
|DBMS|Payload|
|---|---|
|MySQL|`'abc\'' INTO OUTFILE -- '`|
|PostgreSQL|`$$='$$=chr(61)\|\|chr(0x27) and 1=pg_sleep(2)\|\|version()'`|
|Oracle|`NVL(TO_CHAR(DBMS_XMLGEN.getxml('select 1 where 1337>1')),'1')!='1'`|
|MS SQL|`1<LEN(%C2%A0(select%C2%A0top%C2%A01%C2%A0name%C2%A0from%C2%A0users)`|

---
## Reference
https://ufo.stealien.com/2022-12-16/analyzing-django-orm-with-1-day#2-cve-2022-28346
https://www.synacktiv.com/ressources/hql2sql_sstic_2015_en.pdf